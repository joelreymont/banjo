---
title: Refactor bridge.lua for per-tab backend instances
status: closed
priority: 2
issue-type: task
created-at: "2026-01-06T06:34:57.291171+02:00"
closed-at: "2026-01-06T06:37:24.145513+02:00"
---

File: nvim/lua/banjo/bridge.lua
Problem: Module-level state (client, job_id, state, reconnect, etc.) shared across all tabs.
Solution: 
1. Remove line 8 (panel.set_bridge(M)) - bridge ref must be set per-tab
2. Create local bridges = {} indexed by tabpage ID
3. Add get_bridge() helper: local tabid = vim.api.nvim_get_current_tabpage(); if not bridges[tabid] then bridges[tabid] = {client=nil, job_id=nil, state={...}, reconnect={...}, preserved={...}}; panel.set_bridge(M, tabid)
4. Add set_active_tab() to switch context for panel callbacks
5. Update all M.* functions to use get_bridge().field
6. Add TabClosed autocmd to clean up (jobstop, ws_client.close, delete bridges[tabid])
7. Fix M.send_prompt to use tab-local CWD (via reconnect.cwd or vim.fn.getcwd())
Dependencies: panel.lua per-tab state (DONE)
